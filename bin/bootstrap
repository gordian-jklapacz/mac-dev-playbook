#!/bin/bash
set -euo pipefail

PATH_OVERRIDE="$HOME/Library/Python/3.8/bin:/opt/homebrew/bin:$PATH"

function check-xcode {
  res=$(/usr/bin/xcode-select -p 2>&1)
  [[ "${res}" =~ "error: unable" ]] && xcode-select --install
  [[ "${res}" =~ " " ]] && return 111
  [[ ! -x "${res}/usr/bin/git" ]] && return 112

  git_version="$(${res}/usr/bin/git --version 2>/dev/null)"
  [[ -z "${git_version}" ]] && return 113

  printf "cli tools ok!\n"
}

function install-rosetta() {
  /usr/sbin/softwareupdate --install-rosetta --agree-to-license
}

function check-rosetta(){
  [[ ! -f /Library/Apple/usr/lib/libRosettaAot.dylib ]] && install-rosetta
  printf "Rosetta already installed!\n"
}

function install-ansible() {
  sudo /usr/bin/pip3 install --upgrade pip
  /usr/bin/pip3 install ansible
}

function run-installation() {
  dev_dir="$HOME/Development/GitHub"
  mkdir -p "${dev_dir}"
  setup_dir="${dev_dir}/setup"
  [[ -d "${setup_dir}" ]] || git clone https://github.com/gordian-jklapacz/mac-dev-playbook "${setup_dir}"
  pushd "${setup_dir}"
    ./bin/apply
  popd
}

function main() {
  export PATH="$PATH_OVERRIDE"
  check-rosetta
  check-xcode
  [[ $(command -v ansible-playbook 2>/dev/null) ]] || install-ansible
  run-installation
}

main
